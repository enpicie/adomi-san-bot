name: 'Deploy Infrastructure via HCP Terraform'

on:
  workflow_call:
    inputs:
      app_name:
        description: Name of the application
        required: true
        type: string
      sqs_worker_name:
        description: Name of the application
        required: true
        type: string
      deployment_env:
        description: Environment to deploy to (e.g., dev, prod)
        required: true
        type: string
      python_runtime:
        description: Python runtime for Lambda (e.g., 3.11)
        required: true
        type: string
      aws_region:
        description: AWS Region to deploy to
        required: true
        type: string
      artifact_s3_bucket:
        description: S3 bucket name for storing build artifacts
        required: true
        type: string
      hcp_terraform_org:
        description: HCP Terraform Organization name
        required: true
        type: string
      hcp_terraform_workspace:
        description: HCP Terraform Workspace name
        required: true
        type: string
      hcp_terraform_project:
        description: HCP Terraform Project name
        required: true
        type: string
      app_version:
        description: Version of the application
        required: false
        type: string
      discord_public_key:
        description: Public key for Discord verification (env-specific and used by Terraform)
        required: true
        type: string
    secrets:
      AWS_S3_ARTIFACT_UPLOAD_ROLE_ARN:
        required: true
      TF_API_TOKEN:
        required: true
      STARTGG_API_TOKEN:
        required: true
      DISCORD_BOT_TOKEN:
        required: true

jobs:
  deploy-via-hcp-terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # This action checks the commit history to see if any files matching the filters have changed.
      - name: Check for relevant file changes (src or terraform)
        id: filter
        uses: dorny/paths-filter@v3
        with:
          # Define a single filter 'run_deployment' that is true if a change occurs in either path
          filters: |
            run_deployment:
              - 'src/**'
              - 'terraform/**'

      - name: Log Deployment Decision
        run: |
          if [ "${{ steps.filter.outputs.run_deployment }}" == "true" ]; then
            echo "::notice title=Deployment Decision::Changes detected in 'src' or 'terraform'. Full deployment proceeding."
          else
            echo "::warning title=Deployment Decision::No changes detected in 'src' or 'terraform'. Skipping deployment steps."
          fi

      # The rest of the workflow steps are now conditionally executed based on the filter output.
      - name: Setup HCP Terraform Workspace
        if: steps.filter.outputs.run_deployment == 'true'
        id: setup_workspace
        uses: enpicie/action-workflow-hcp-terraform-workspace-setup@v1.1.0
        with:
          tfc_organization: ${{ inputs.hcp_terraform_org }}
          tfc_workspace: ${{ inputs.hcp_terraform_workspace }}
          tfc_project: ${{ inputs.hcp_terraform_project }}
          tfc_token: ${{ secrets.TF_API_TOKEN }}

      - name: Attach IAM Permissions Variable Set to this Workspace
        if: steps.filter.outputs.run_deployment == 'true'
        uses: enpicie/action-workflow-hcp-terraform-var-set-attach@v1.0.1
        with:
          tfc_organization: ${{ inputs.hcp_terraform_org }}
          tfc_workspace_id: ${{ steps.setup_workspace.outputs.workspace_id }}
          tfc_token: ${{ secrets.TF_API_TOKEN }}
          var_set_name: ${{ vars.AWS_TF_ROLE_VARSET_LAMB_APIGW_DDB_SQS }}

      - name: Build and Upload Lambda Layer Artifact to S3 - Main Lambda
        if: steps.filter.outputs.run_deployment == 'true'
        id: build_layer
        uses: enpicie/action-workflow-build-python-lambda-layer-zip@v2.0.4
        with:
          requirements_path: ./requirements.txt # Path relative the repository root
          app_name: ${{ inputs.app_name }}
          python_runtime: ${{ inputs.python_runtime }}
          s3_layer_bucket_name: ${{ inputs.artifact_s3_bucket }} # Store layer in same bucket for env as artifacts
          aws_role_arn: ${{ secrets.AWS_S3_ARTIFACT_UPLOAD_ROLE_ARN }}

      - name: Build and Upload Lambda Layer Artifact to S3 - SQS Worker Lambda
        if: steps.filter.outputs.run_deployment == 'true'
        id: build_layer_worker
        uses: enpicie/action-workflow-build-python-lambda-layer-zip@v2.0.4
        with:
          requirements_path: ./jobs/remove_role/requirements.txt # Path relative the repository root
          app_name: ${{ inputs.sqs_worker_name }}
          python_runtime: ${{ inputs.python_runtime }}
          s3_layer_bucket_name: ${{ inputs.artifact_s3_bucket }}
          aws_role_arn: ${{ secrets.AWS_S3_ARTIFACT_UPLOAD_ROLE_ARN }}

      - name: Upload Latest Lambda Zip to S3 - Main Lambda
        if: steps.filter.outputs.run_deployment == 'true'
        uses: enpicie/action-workflow-upload-lambda-zip@v0.3.0
        with:
          source_directory: ./src
          app_name: ${{ inputs.app_name }}
          artifact_name: ${{ inputs.app_name }}-latest
          s3_bucket_name: ${{ inputs.artifact_s3_bucket }}
          aws_role_arn: ${{ secrets.AWS_S3_ARTIFACT_UPLOAD_ROLE_ARN }}

      - name: Upload Version Lambda Zip to S3 - Main Lambda
        if: ${{ inputs.app_version != '' && steps.filter.outputs.run_deployment == 'true' }}
        uses: enpicie/action-workflow-upload-lambda-zip@v0.3.0
        with:
          source_directory: ./src
          app_name: ${{ inputs.app_name }}
          artifact_name: ${{ inputs.app_name }}-${{ inputs.app_version }}
          s3_bucket_name: ${{ inputs.artifact_s3_bucket }}
          aws_role_arn: ${{ secrets.AWS_S3_ARTIFACT_UPLOAD_ROLE_ARN }}

      - name: Upload Latest Lambda Zip to S3 - SWS Worker Lambda
        if: steps.filter.outputs.run_deployment == 'true'
        uses: enpicie/action-workflow-upload-lambda-zip@v0.3.0
        with:
          source_directory: ./jobs/remove_role
          app_name: ${{ inputs.sqs_worker_name }}
          artifact_name: ${{ inputs.sqs_worker_name }}-latest
          s3_bucket_name: ${{ inputs.artifact_s3_bucket }}
          aws_role_arn: ${{ secrets.AWS_S3_ARTIFACT_UPLOAD_ROLE_ARN }}

      - name: Log Terraform input variables
        if: steps.filter.outputs.run_deployment == 'true'
        shell: bash
        run: |
          echo "Logging Terraform variables:"
          echo "TF_VAR_app_name=${TF_VAR_app_name}"
          echo "TF_VAR_aws_region=${TF_VAR_aws_region}"
          echo "TF_VAR_python_runtime=${TF_VAR_python_runtime}"
          echo "TF_VAR_deployment_env=${TF_VAR_deployment_env}"
          echo "TF_VAR_bucket_name=${TF_VAR_bucket_name}"
          echo "TF_VAR_app_lambda_layer_s3_key=${TF_VAR_app_lambda_layer_s3_key}"
          echo "TF_VAR_app_lambda_layer_hash_s3_key=${TF_VAR_app_lambda_layer_hash_s3_key}"
          echo "TF_VAR_worker_lambda_layer_s3_key=${TF_VAR_worker_lambda_layer_s3_key}"
          echo "TF_VAR_worker_lambda_layer_hash_s3_key=${TF_VAR_worker_lambda_layer_hash_s3_key}"
          echo "TF_VAR_discord_public_key=${TF_VAR_discord_public_key}"
        env:
          TF_VAR_app_name: '${{ inputs.app_name }}'
          TF_VAR_aws_region: '${{ inputs.aws_region }}'
          TF_VAR_python_runtime: '${{ inputs.python_runtime }}'
          TF_VAR_deployment_env: '${{ inputs.deployment_env }}'
          TF_VAR_bucket_name: '${{ inputs.artifact_s3_bucket }}'
          # These outputs are guaranteed to be set if the conditional Build steps run.
          TF_VAR_app_lambda_layer_s3_key: '${{ steps.build_layer.outputs.s3_artifact_key }}'
          TF_VAR_app_lambda_layer_hash_s3_key: '${{ steps.build_layer.outputs.s3_artifact_hash_key }}'
          TF_VAR_worker_lambda_layer_s3_key: '${{ steps.build_layer_worker.outputs.s3_artifact_key }}'
          TF_VAR_worker_lambda_layer_hash_s3_key: '${{ steps.build_layer_worker.outputs.s3_artifact_hash_key }}'
          TF_VAR_discord_public_key: '${{ inputs.discord_public_key }}'

      - name: Deploy Application Config via HCP Terraform
        if: steps.filter.outputs.run_deployment == 'true'
        uses: enpicie/action-workflow-hcp-terraform-run@v1.1.1
        with:
          terraform_directory: ./terraform
          tfc_organization: ${{ inputs.hcp_terraform_org }}
          tfc_workspace: ${{ inputs.hcp_terraform_workspace }}
          tfc_token: ${{ secrets.TF_API_TOKEN }}
        env:
          # Need explicit quotes to pass strings as string literaly correctly
          TF_VAR_app_name: '"${{ inputs.app_name }}"'
          TF_VAR_sqs_worker_name: '"${{ inputs.sqs_worker_name }}"'
          TF_VAR_aws_region: '"${{ inputs.aws_region }}"'
          TF_VAR_python_runtime: '"${{ inputs.python_runtime }}"'
          TF_VAR_deployment_env: '"${{ inputs.deployment_env }}"'
          TF_VAR_bucket_name: '"${{ inputs.artifact_s3_bucket }}"'
          TF_VAR_app_lambda_layer_s3_key: '"${{ steps.build_layer.outputs.s3_artifact_key }}"'
          TF_VAR_app_lambda_layer_hash_s3_key: '"${{ steps.build_layer.outputs.s3_artifact_hash_key }}"'
          TF_VAR_worker_lambda_layer_s3_key: '"${{ steps.build_layer_worker.outputs.s3_artifact_key }}"'
          TF_VAR_worker_lambda_layer_hash_s3_key: '"${{ steps.build_layer_worker.outputs.s3_artifact_hash_key }}"'
          TF_VAR_discord_public_key: '"${{ inputs.discord_public_key }}"'
          TF_VAR_startgg_api_token: '"${{ secrets.STARTGG_API_TOKEN }}"'
          TF_VAR_discord_bot_token: '"${{ secrets.DISCORD_BOT_TOKEN }}"'
